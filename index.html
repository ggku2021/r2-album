<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç›¸å†Œ / My Album</title>
  <style>
    :root{--gap:10px;--bg:#0f1724;--card:#0b1220;--text:#e6eef8}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC";background:var(--bg);color:var(--text)}
    header{padding:16px;text-align:center}
    header h1{margin:0;font-size:1.2rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:var(--gap);padding:12px;max-width:1200px;margin:0 auto}
    .thumb{display:block;overflow:hidden;border-radius:8px;background:#111;padding:4px;text-align:center}
    .thumb img{width:100%;height:160px;object-fit:cover;border-radius:6px;display:block;transition:transform .25s}
    .thumb:hover img{transform:scale(1.03)}
    .caption{font-size:0.85rem;padding:6px 4px;text-align:center;color:#cfe6ff}
    /* Lightbox */
    .lb{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:999;visibility:hidden;opacity:0;transition:opacity .18s}
    .lb.show{visibility:visible;opacity:1}
    .lb img{max-width:94vw;max-height:82vh;border-radius:6px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
    .lb .info{position:fixed;left:16px;bottom:16px;color:#dfeefe;font-size:0.95rem}
    .btn{position:fixed;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.4);border:0;color:#fff;font-size:2rem;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.08)}
    .prev{left:10px} .next{right:10px}
    .close{position:fixed;top:12px;right:12px;background:transparent;border:0;color:#fff;font-size:28px;cursor:pointer}
    @media (max-width:480px){ .thumb img{height:120px} }
  </style>
</head>
<body>
  <header>
    <h1>ç›¸å†Œ / Gallery</h1>
    <div style="font-size:0.85rem;color:#9fb5d9;margin-top:6px">è‡ªåŠ¨è¯»å– images.json â†’ ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹å¤§å›¾ï¼ˆé”®ç›˜ â† â†’ / Esc æ”¯æŒï¼‰</div>
  </header>

  <main>
    <div id="gallery" class="grid" aria-live="polite"></div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="lb" role="dialog" aria-hidden="true">
    <button id="closeBtn" class="close" aria-label="å…³é—­">âœ•</button>
    <button id="prevBtn" class="btn prev" aria-label="ä¸Šä¸€å¼ ">â€¹</button>
    <img id="lbImg" src="" alt="">
    <button id="nextBtn" class="btn next" aria-label="ä¸‹ä¸€å¼ ">â€º</button>
    <div id="lbCaption" class="info"></div>
  </div>

  <script>
const jsonPath = 'images.json'; // images.json åœ¨ä»“åº“æ ¹
let galleryData = []; // å­˜å‚¨æ ¹ç›®å½•å›¾ç‰‡å’Œæ–‡ä»¶å¤¹
let flatImages = [];  // æ‰å¹³åŒ–æ‰€æœ‰å›¾ç‰‡ï¼Œç”¨äº Lightbox
let currentIndex = 0;

async function fetchImages() {
  try {
    const res = await fetch(jsonPath, {cache: "no-store"});
    if(!res.ok) throw new Error('æ— æ³•è¯»å– images.json: ' + res.status);
    galleryData = await res.json();
    renderGallery();
    flattenImages();
  } catch(e) {
    console.error(e);
    document.getElementById('gallery').innerHTML = '<div style="padding:20px;color:#f88">è½½å…¥å›¾ç‰‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ images.json æ˜¯å¦å­˜åœ¨å¹¶ä¸”æ ¼å¼æ­£ç¡®ã€‚</div>';
  }
}

function renderGallery() {
  const container = document.getElementById('gallery');
  if(!Array.isArray(galleryData) || galleryData.length===0) {
    container.innerHTML = '<div style="padding:16px;color:#9fb5d9">ç›¸å†Œæš‚æ— å›¾ç‰‡ï¼Œä¸Šä¼ åˆ° images/ æ–‡ä»¶å¤¹å¹¶è§¦å‘ workflow å³å¯ã€‚</div>';
    return;
  }

  container.innerHTML = galleryData.map((item,i) => {
    if(item.type==='folder') {
      return `
        <div class="thumb folder" data-index="${i}">
          <img loading="lazy" src="${item.cover}" alt="${item.title}">
          <div class="caption">ğŸ“ ${item.title}</div>
        </div>
      `;
    } else {
      return `
        <a href="${item.url}" class="thumb" data-index="${i}">
          <img loading="lazy" src="${item.url}" alt="${item.title}">
          <div class="caption">${item.title}</div>
        </a>
      `;
    }
  }).join('');

  // ç»‘å®šäº‹ä»¶
  container.querySelectorAll('.thumb').forEach(el => {
    el.addEventListener('click', e => {
      const idx = +el.dataset.index;
      const item = galleryData[idx];
      if(item.type==='folder') {
        // å±•å¼€æ–‡ä»¶å¤¹
        renderFolderImages(idx, el);
      } else {
        e.preventDefault();
        openLightbox(flatImages.indexOf(item));
      }
    });
  });
}

function renderFolderImages(folderIndex, containerEl) {
  const folder = galleryData[folderIndex];
  if(!folder.children || folder.children.length===0) return;

  // é¿å…é‡å¤å±•å¼€
  if(containerEl.nextSibling && containerEl.nextSibling.classList.contains('folder-children')) {
    containerEl.nextSibling.remove();
    return;
  }

  const div = document.createElement('div');
  div.className = 'grid folder-children';
  div.style.marginTop='6px';
  div.style.marginBottom='12px';
  div.innerHTML = folder.children.map((img,i) => `
    <a href="${img.url}" class="thumb" data-index="${flatImages.indexOf(img)}">
      <img loading="lazy" src="${img.url}" alt="${img.title}">
      <div class="caption">${img.title}</div>
    </a>
  `).join('');
  containerEl.parentNode.insertBefore(div, containerEl.nextSibling);

  div.querySelectorAll('.thumb').forEach(el=>{
    el.addEventListener('click', e=>{
      e.preventDefault();
      const idx = +el.dataset.index;
      openLightbox(idx);
    });
  });
}

function flattenImages() {
  flatImages = [];
  galleryData.forEach(item=>{
    if(item.type==='folder' && item.children) {
      flatImages.push(...item.children);
    } else if(item.type==='image') {
      flatImages.push(item);
    }
  });
}

// Lightbox
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lbImg');
const lbCaption = document.getElementById('lbCaption');
document.getElementById('closeBtn').addEventListener('click', closeLightbox);
document.getElementById('prevBtn').addEventListener('click', () => show(currentIndex-1));
document.getElementById('nextBtn').addEventListener('click', () => show(currentIndex+1));
lb.addEventListener('click', (e)=>{ if(e.target===lb) closeLightbox(); });

function openLightbox(idx){
  if(idx<0 || idx>=flatImages.length) return;
  currentIndex = idx;
  show(currentIndex);
  lb.classList.add('show');
  lb.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';
}

function closeLightbox(){
  lb.classList.remove('show');
  lb.setAttribute('aria-hidden','true');
  lbImg.src='';
  document.body.style.overflow='';
}

function show(idx){
  if(idx<0) idx = flatImages.length-1;
  if(idx>=flatImages.length) idx = 0;
  currentIndex = idx;
  const item = flatImages[idx];
  lbImg.src = item.url;
  lbImg.alt = item.title||item.filename||'';
  lbCaption.textContent = item.title||item.filename||'';
}

// é”®ç›˜æ”¯æŒ
window.addEventListener('keydown',(e)=>{
  if(!lb.classList.contains('show')) return;
  if(e.key==='Escape') closeLightbox();
  if(e.key==='ArrowLeft') show(currentIndex-1);
  if(e.key==='ArrowRight') show(currentIndex+1);
});

// å¯åŠ¨
fetchImages();
</script>

</body>
</html>
