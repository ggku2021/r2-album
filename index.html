<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ GitHub å›¾åºŠç›¸å†Œ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        h1 { color: #333; text-align: center; margin-bottom: 40px; }
        
        /* æœç´¢å’Œåˆ†é¡µæ§ä»¶å®¹å™¨ */
        #controls {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
        }
        #search-input {
            padding: 10px;
            width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #pagination button {
            padding: 8px 15px;
            margin: 0 5px;
            border: 1px solid #007bff;
            border-radius: 4px;
            background-color: #fff;
            color: #007bff;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #pagination button:hover:not(:disabled) {
            background-color: #007bff;
            color: #fff;
        }
        #pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ç›¸å†Œç½‘æ ¼ */
        #gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        /* ç›¸å†Œ/å›¾ç‰‡é¡¹æ ·å¼ */
        .item-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 250px; 
            text-align: center;
            transition: transform 0.2s;
            cursor: pointer;
            height: auto; 
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* æ–‡ä»¶å¤¹ï¼ˆç›¸å†Œï¼‰æ ·å¼ */
        .folder-card {
            background-color: #e0f7fa;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 250px;
        }
        .folder-card::before {
            content: "ğŸ“";
            margin-right: 10px;
            font-size: 1.5em;
        }

        /* å›¾ç‰‡å®¹å™¨å’Œå›¾ç‰‡æœ¬èº«çš„æ ·å¼ */
        .image-container {
            width: 100%;
            height: 250px; 
            overflow: hidden; 
        }

        .image-card img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover; 
            transition: transform 0.3s ease-in-out;
        }
        .image-card:hover img {
            transform: scale(1.05);
        }

        .image-card p {
            padding: 10px;
            margin: 0;
            color: #555;
            font-size: 0.9em;
            min-height: 40px; 
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all; /* å…è®¸é•¿æ–‡ä»¶åæ¢è¡Œ */
        }
        
        /* æç¤ºä¿¡æ¯ */
        #message {
            text-align: center;
            color: #888;
            margin-top: 50px;
        }
    </style>
</head>
<body>

    <h1 id="page-title">ç›¸å†Œä¸»é¡µ</h1>
    
    <div id="controls">
        <input type="text" id="search-input" placeholder="æŒ‰æ–‡ä»¶åæœç´¢..." />
        <div id="pagination">
            </div>
    </div>
    <div id="gallery">
        <div id="message">æ­£åœ¨åŠ è½½ç›¸å†Œå†…å®¹...</div>
    </div>
    
    <script>
        // =======================================================
        // ğŸš€ é…ç½®ä¿¡æ¯
        // =======================================================
        const GITHUB_USERNAME = 'ggku2021'; 
        const GITHUB_REPO_NAME = 'r2-album'; 
        const GITHUB_BRANCH = 'main'; 
        const BASE_PATH = 'img'; 
        const ITEMS_PER_PAGE = 12; // ğŸ‘ˆ è®¾å®šæ¯é¡µæ˜¾ç¤ºçš„é¡¹ç›®æ•°é‡ (æ–‡ä»¶å¤¹+å›¾ç‰‡)
        // =======================================================

        const gallery = document.getElementById('gallery');
        const message = document.getElementById('message');
        const pageTitle = document.getElementById('page-title');
        const searchInput = document.getElementById('search-input');
        const paginationContainer = document.getElementById('pagination');

        // å…¨å±€çŠ¶æ€å˜é‡
        let currentPath = BASE_PATH; // å½“å‰è·¯å¾„
        let allItemsCache = []; // å½“å‰æ–‡ä»¶å¤¹çš„æ‰€æœ‰é¡¹ç›®ç¼“å­˜
        let currentItems = []; // å½“å‰é¡µé¢çš„é¡¹ç›® (ç»è¿‡æœç´¢è¿‡æ»¤)
        let currentPage = 1; // å½“å‰é¡µç 

        /* --- API å’Œè·¯å¾„å‡½æ•° --- */

        function getContentApiUrl(path) {
            return `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}/contents/${path}?ref=${GITHUB_BRANCH}`;
        }

        function getCdnUrl(path) {
            const cleanPath = path.startsWith('/') ? path.substring(1) : path; 
            return `https://cdn.jsdelivr.net/gh/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}@${GITHUB_BRANCH}/${cleanPath}`;
        }

        function isImage(name) {
            const lowerName = name.toLowerCase();
            return lowerName.endsWith('.jpg') || lowerName.endsWith('.jpeg') || lowerName.endsWith('.png') || lowerName.endsWith('.gif') || lowerName.endsWith('.webp');
        }

        /* --- æ¸²æŸ“é€»è¾‘ --- */

        /**
         * ä¸»æ¸²æŸ“å‡½æ•°ï¼šåŠ è½½æ•°æ®å¹¶è°ƒç”¨æœ¬åœ°æ¸²æŸ“
         */
        async function loadAndRenderGallery(path) {
            currentPath = path;
            currentPage = 1; // åˆ‡æ¢è·¯å¾„ï¼Œé‡ç½®åˆ°ç¬¬ä¸€é¡µ
            pageTitle.textContent = 'æ­£åœ¨åŠ è½½...';
            gallery.innerHTML = '';
            message.textContent = 'æ­£åœ¨åŠ è½½ç›¸å†Œå†…å®¹...';
            
            try {
                const response = await fetch(getContentApiUrl(path));
                if (!response.ok) {
                    throw new Error(`GitHub API é”™è¯¯: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.length === 0) {
                    message.textContent = 'æ­¤ç›¸å†Œä¸ºç©ºã€‚';
                    allItemsCache = [];
                    renderCurrentPage();
                    return;
                }

                // ç¼“å­˜æ‰€æœ‰æ•°æ®
                allItemsCache = data;
                message.style.display = 'none';

                // é¦–æ¬¡åŠ è½½åï¼Œè§¦å‘æœ¬åœ°æ¸²æŸ“
                renderCurrentPage(); 
                
            } catch (error) {
                console.error("åŠ è½½ç›¸å†Œå¤±è´¥:", error);
                message.textContent = `åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œã€‚é”™è¯¯ï¼š${error.message}`;
                allItemsCache = [];
                renderCurrentPage();
            }
        }

        /**
         * æœ¬åœ°æ¸²æŸ“å‡½æ•°ï¼šå¤„ç†æœç´¢å’Œåˆ†é¡µ
         */
        function renderCurrentPage() {
            // 1. è®¾ç½®é¡µé¢æ ‡é¢˜
            const isRoot = currentPath === BASE_PATH;
            const folderName = currentPath.split('/').pop();
            pageTitle.textContent = isRoot ? 'ç›¸å†Œä¸»é¡µ' : `ç›¸å†Œï¼š${folderName}`;

            // 2. å¤„ç†æœç´¢è¿‡æ»¤
            const searchTerm = searchInput.value.toLowerCase().trim();
            let filteredItems = allItemsCache;

            if (searchTerm) {
                // ä»…åœ¨æœç´¢æ—¶è¿‡æ»¤ï¼Œå¦åˆ™ä½¿ç”¨å…¨éƒ¨ç¼“å­˜æ•°æ®
                filteredItems = allItemsCache.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            }

            // 3. åŒºåˆ†æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
            const folders = filteredItems.filter(item => item.type === 'dir');
            const files = filteredItems.filter(item => item.type === 'file' && isImage(item.name));
            
            currentItems = [...folders, ...files]; // æ–‡ä»¶å¤¹ä¼˜å…ˆå±•ç¤º

            // 4. è®¡ç®—åˆ†é¡µ
            const totalItems = currentItems.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            // ç¡®ä¿å½“å‰é¡µç æœ‰æ•ˆ
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1;
            }

            // 5. ç¡®å®šå½“å‰é¡µé¢çš„å†…å®¹
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);
            const itemsOnPage = currentItems.slice(startIndex, endIndex);

            // 6. æ¸…ç©ºç”»å»Šå¹¶æ¸²æŸ“
            gallery.innerHTML = '';
            if (totalItems === 0) {
                 gallery.innerHTML = `<div id="message" style="display:block;">${searchTerm ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶ã€‚' : 'æ­¤ç›¸å†Œä¸ºç©ºã€‚'}</div>`;
            } else {
                 message.style.display = 'none';
            }
            
            // æ¸²æŸ“è¿”å›ä¸Šä¸€çº§æŒ‰é’®
            if (currentPath !== BASE_PATH) {
                const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                const backButton = createFolderCard('... è¿”å›ä¸Šä¸€çº§', parentPath, true); // æ ‡è®°ä¸ºè¿”å›æŒ‰é’®
                gallery.appendChild(backButton);
            }

            // æ¸²æŸ“å½“å‰é¡µé¢çš„é¡¹ç›®
            itemsOnPage.forEach(item => {
                if (item.type === 'dir') {
                    gallery.appendChild(createFolderCard(item.name, item.path));
                } else if (item.type === 'file') {
                    gallery.appendChild(createImageCard(item.name, item.path));
                }
            });

            // 7. æ¸²æŸ“åˆ†é¡µæ§ä»¶
            renderPaginationControls(totalPages);
        }

        /**
         * æ¸²æŸ“åˆ†é¡µæŒ‰é’®
         */
        function renderPaginationControls(totalPages) {
            paginationContainer.innerHTML = '';

            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'ä¸Šä¸€é¡µ';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderCurrentPage(); window.scrollTo(0, 0); }; // å›åˆ°é¡¶éƒ¨
            
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
            pageInfo.style.margin = '0 10px';
            pageInfo.style.fontWeight = 'bold';

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderCurrentPage(); window.scrollTo(0, 0); }; // å›åˆ°é¡¶éƒ¨

            paginationContainer.appendChild(prevBtn);
            paginationContainer.appendChild(pageInfo);
            paginationContainer.appendChild(nextBtn);
        }

        /* --- å…ƒç´ åˆ›å»ºå‡½æ•° (ä¿æŒç¨³å®š) --- */

        function createFolderCard(name, path, isBackButton = false) {
            const card = document.createElement('div');
            card.className = 'item-card folder-card';
            card.textContent = name;
            card.onclick = () => loadAndRenderGallery(path);
            if (isBackButton) {
                 card.style.backgroundColor = '#ffcdd2'; 
                 card.style.fontWeight = 'normal';
                 card.style.minHeight = '250px'; // ç¡®ä¿è¿”å›æŒ‰é’®é«˜åº¦
            }
            return card;
        }

        function createImageCard(name, path) {
            const card = document.createElement('div');
            card.className = 'item-card image-card';

            const imgContainer = document.createElement('div');
            imgContainer.className = 'image-container';

            const img = document.createElement('img');
            img.src = getCdnUrl(path);
            img.alt = name;
            
            const p = document.createElement('p');
            p.textContent = name; 

            imgContainer.appendChild(img);
            card.appendChild(imgContainer);
            card.appendChild(p);

            card.onclick = () => window.open(getCdnUrl(path), '_blank'); 

            return card;
        }

        /* --- äº‹ä»¶ç›‘å¬ --- */

        // ç›‘å¬æœç´¢æ¡†è¾“å…¥ï¼Œå®æ—¶è§¦å‘æœ¬åœ°æ¸²æŸ“
        searchInput.addEventListener('input', () => {
            currentPage = 1; // æœç´¢æ—¶é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            renderCurrentPage();
        });

        // é¡µé¢åˆå§‹åŒ–æ—¶åŠ è½½
        loadAndRenderGallery(BASE_PATH);
    </script>

</body>
</html>