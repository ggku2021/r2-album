<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ GitHub å›¾åºŠç›¸å†Œ</title>
    <style>
        /* ç§»åŠ¨ç«¯åŸºç¡€é€‚é…å’Œæ’ç‰ˆè®¾ç½® */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0;
            padding: 20px 10px;
            background-color: #f4f4f9; 
            font-size: 14px;
        }
        h1 { 
            color: #333; 
            text-align: center; 
            margin-bottom: 20px; 
            font-size: 1.6rem; 
        }
        
        /* æœç´¢å’Œåˆ†é¡µæ§ä»¶å®¹å™¨ä¼˜åŒ–ï¼ˆå±…ä¸­ï¼‰ */
        #controls {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 10px;
            align-items: center;
            max-width: 1200px; 
            margin: 0 auto 20px auto; 
        }
        #search-input {
            padding: 8px;
            width: 80%;
            max-width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }
        #pagination {
            flex-grow: 1;
            display: flex;
            justify-content: center;
        }
        #pagination button {
            padding: 6px 12px;
            margin: 0 3px;
            border: 1px solid #007bff;
            border-radius: 4px;
            background-color: #fff;
            color: #007bff;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* åˆ—è¡¨å·¦å¯¹é½ */
        #gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: flex-start; 
            max-width: 1200px; 
            margin: 0 auto;
        }

        /* ç›¸å†Œ/å›¾ç‰‡é¡¹åŸºç¡€æ ·å¼ */
        .item-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: calc(50% - 10px); 
            min-width: 150px;
            max-width: 250px; 
            text-align: center;
            transition: transform 0.2s;
            cursor: pointer;
            height: auto; 
            position: relative; /* ç”¨äºæ–‡ä»¶å¤¹åç§°å åŠ  */
        }
        /* PCç«¯åª’ä½“æŸ¥è¯¢ï¼šä¸‰åˆ—ä»¥ä¸Šå›ºå®šå®½åº¦ */
        @media (min-width: 768px) {
            .item-card {
                width: 250px; 
            }
        }

        /* æ–‡ä»¶å¤¹ï¼ˆç›¸å†Œï¼‰æ ·å¼ï¼šä½¿ç”¨å›¾ç‰‡å°é¢ï¼Œåç§°å åŠ åœ¨ä¸Šé¢ */
        .folder-card {
            background-color: #e0f7fa; /* é»˜è®¤èƒŒæ™¯ï¼Œä»¥é˜²æ²¡æœ‰å°é¢å›¾ */
            padding: 0; /* ç§»é™¤å†…è¾¹è·ï¼Œè®©å›¾ç‰‡å¡«å…… */
            display: flex;
            flex-direction: column; /* å‚ç›´å¸ƒå±€å†…å®¹ */
            align-items: center; 
            justify-content: center;
            min-height: calc(250px + 30px + 16px); /* ä¿æŒä¸å›¾ç‰‡å¡ç‰‡æ€»é«˜åº¦ä¸€è‡´ */
            height: auto; 
            background-size: cover; /* å°é¢å›¾å¡«å…… */
            background-position: center center; /* å°é¢å›¾å±…ä¸­ */
            color: #fff; /* é»˜è®¤ç™½è‰²æ–‡å­— */
            text-shadow: 0 0 5px rgba(0,0,0,0.7); /* æ–‡å­—é˜´å½±å¢å¼ºå¯è¯»æ€§ */
        }

        .folder-card .folder-name {
            font-size: 1.2rem; /* å­—ä½“å¤§ä¸€ç‚¹ */
            font-weight: bold;
            padding: 8px 5px;
            margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
            width: 100%;
            box-sizing: border-box; /* åŒ…å« padding åœ¨å®½åº¦å†… */
            background-color: rgba(0, 0, 0, 0.5); /* åŠé€æ˜åº•è‰²å— */
            position: absolute; /* å åŠ åœ¨å›¾ç‰‡ä¸Š */
            bottom: 0;
            left: 0;
            color: #fff; /* ç¡®ä¿æ–‡å­—é¢œè‰² */
        }
        
        .folder-card::before {
            content: ""; /* ç§»é™¤é»˜è®¤çš„æ–‡ä»¶å¤¹å›¾æ ‡ */
            margin-right: 0;
            font-size: 0;
        }

        .folder-card.no-cover {
            background-color: #e0f7fa; /* æ²¡æœ‰å°é¢æ—¶å›é€€ */
            color: #333;
            text-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .folder-card.no-cover .folder-name {
            background-color: transparent;
            position: static; /* æ²¡æœ‰å°é¢æ—¶æ–‡å­—æ­£å¸¸æµ */
            color: #333;
        }
        .folder-card.no-cover::before {
             content: "ğŸ“"; /* æ²¡æœ‰å°é¢æ—¶æ˜¾ç¤ºé»˜è®¤å›¾æ ‡ */
             margin-right: 5px;
             font-size: 1.2rem;
             color: #333;
        }


        .back-button {
            background-color: #ffcdd2 !important;
            font-weight: normal !important;
            color: #333 !important;
            text-shadow: none !important;
        }
        .back-button .folder-name {
            background-color: transparent !important;
            color: #333 !important;
            position: static !important;
        }
        .back-button::before {
            content: "â¬…ï¸" !important;
            margin-right: 5px !important;
            font-size: 1.2rem !important;
        }


        /* å›¾ç‰‡å®¹å™¨å’Œå›¾ç‰‡æœ¬èº«çš„æ ·å¼ */
        .image-container {
            width: 100%;
            height: 250px; 
            overflow: hidden; 
        }

        .image-card img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover; 
            transition: transform 0.3s ease-in-out;
        }

        .image-card p {
            padding: 8px 5px;
            margin: 0;
            color: #555;
            font-size: 0.85rem; 
            min-height: 30px; 
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
        }
        
        /* æç¤ºä¿¡æ¯ */
        #message {
            text-align: center;
            color: #888;
            margin-top: 50px;
            width: 100%;
        }
    </style>
</head>
<body>

    <h1 id="page-title">ç›¸å†Œä¸»é¡µ</h1>
    
    <div id="controls">
        <input type="text" id="search-input" placeholder="å…¨å±€æœç´¢æ–‡ä»¶å..." />
        <div id="pagination">
            </div>
    </div>
    <div id="gallery">
        <div id="message">æ­£åœ¨åŠ è½½ç›¸å†Œå†…å®¹...</div>
    </div>
    
    <script>
        // =======================================================
        // ğŸš€ é…ç½®ä¿¡æ¯
        // =======================================================
        const GITHUB_USERNAME = 'ggku2021'; 
        const GITHUB_REPO_NAME = 'r2-album'; 
        const GITHUB_BRANCH = 'main'; 
        const BASE_PATH = 'img'; 
        const ITEMS_PER_PAGE = 12; // æ¯é¡µæ˜¾ç¤ºçš„é¡¹ç›®æ•°é‡ (æ–‡ä»¶å¤¹+å›¾ç‰‡)
        // =======================================================

        const gallery = document.getElementById('gallery');
        const message = document.getElementById('message');
        const pageTitle = document.getElementById('page-title');
        const searchInput = document.getElementById('search-input');
        const paginationContainer = document.getElementById('pagination');

        // å…¨å±€çŠ¶æ€å˜é‡
        let currentPath = BASE_PATH;
        let folderItemsCache = []; 
        let globalImageCache = []; 
        let folderCoverCache = {}; // ğŸ‘ˆ æ–°å¢ï¼šç¼“å­˜æ–‡ä»¶å¤¹å°é¢å›¾ URL
        let currentItems = []; 
        let currentPage = 1;
        let isSearching = false;

        /* --- API å’Œè·¯å¾„å‡½æ•° --- */

        function getContentApiUrl(path) {
            return `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}/contents/${path}?ref=${GITHUB_BRANCH}`;
        }

        function getCdnUrl(path) {
            const cleanPath = path.startsWith('/') ? path.substring(1) : path; 
            return `https://cdn.jsdelivr.net/gh/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}@${GITHUB_BRANCH}/${cleanPath}`;
        }

        function isImage(name) {
            const lowerName = name.toLowerCase();
            return lowerName.endsWith('.jpg') || lowerName.endsWith('.jpeg') || lowerName.endsWith('.png') || lowerName.endsWith('.gif') || lowerName.endsWith('.webp');
        }

        /* --- å…¨å±€æœç´¢åŠ è½½ (Recursive Load) --- */

        /**
         * é€’å½’åŠ è½½æ‰€æœ‰å­æ–‡ä»¶å¤¹çš„å›¾ç‰‡ï¼Œå¹¶æ‰å¹³åŒ–å­˜å‚¨åœ¨ globalImageCache ä¸­ã€‚
         * åŒæ—¶å°è¯•ä¸ºæ¯ä¸ªæ–‡ä»¶å¤¹æ‰¾åˆ°ä¸€ä¸ªå°é¢å›¾ã€‚
         */
        async function loadGlobalImageCache(path = BASE_PATH) {
            try {
                const response = await fetch(getContentApiUrl(path));
                if (!response.ok) {
                    console.warn(`æ— æ³•åŠ è½½è·¯å¾„: ${path}. çŠ¶æ€: ${response.status}`);
                    return [];
                }
                const data = await response.json();
                let images = [];
                let folderImages = []; // å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„å›¾ç‰‡

                for (const item of data) {
                    if (item.type === 'file' && isImage(item.name)) {
                        images.push({ name: item.name, path: item.path, type: 'file' });
                        folderImages.push(item.path); // æ”¶é›†å½“å‰æ–‡ä»¶å¤¹çš„å›¾ç‰‡è·¯å¾„
                    } else if (item.type === 'dir') {
                        // é€’å½’è°ƒç”¨
                        const subImages = await loadGlobalImageCache(item.path);
                        images = images.concat(subImages);
                        // ä»å­æ–‡ä»¶å¤¹çš„å›¾ç‰‡ä¸­éšæœºé€‰ä¸€ä¸ªä½œä¸ºå°é¢ï¼Œå¦‚æœå½“å‰æ–‡ä»¶å¤¹æ²¡æœ‰
                        if (!folderCoverCache[item.path]) {
                            const availableCovers = subImages.map(img => img.path);
                            if (availableCovers.length > 0) {
                                folderCoverCache[item.path] = getCdnUrl(availableCovers[Math.floor(Math.random() * availableCovers.length)]);
                            }
                        }
                    }
                }

                // ä¸ºå½“å‰æ–‡ä»¶å¤¹è®¾ç½®å°é¢å›¾ (ä¼˜å…ˆä½¿ç”¨å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„å›¾ç‰‡)
                if (!folderCoverCache[path] && folderImages.length > 0) {
                    folderCoverCache[path] = getCdnUrl(folderImages[Math.floor(Math.random() * folderImages.length)]);
                }
                
                return images;
            } catch (error) {
                console.error("å…¨å±€åŠ è½½å¤±è´¥:", error);
                return [];
            }
        }
        
        /* --- æ¸²æŸ“é€»è¾‘ --- */

        /**
         * ä¸»æ¸²æŸ“å‡½æ•°ï¼šåŠ è½½æ•°æ®å¹¶è°ƒç”¨æœ¬åœ°æ¸²æŸ“
         */
        async function loadAndRenderGallery(path) {
            isSearching = false;
            searchInput.value = '';
            currentPath = path;
            currentPage = 1;

            pageTitle.textContent = 'æ­£åœ¨åŠ è½½...';
            gallery.innerHTML = '';
            message.textContent = 'æ­£åœ¨åŠ è½½ç›¸å†Œå†…å®¹...';
            
            try {
                // é¦–æ¬¡è¿›å…¥æ ¹ç›®å½•æ—¶ï¼Œå…ˆç¡®ä¿å…¨å±€ç¼“å­˜åŠ è½½å®Œæˆ
                if (path === BASE_PATH && globalImageCache.length === 0) {
                    message.textContent = 'é¦–æ¬¡åŠ è½½ï¼Œæ­£åœ¨æ„å»ºå…¨å±€æœç´¢ç´¢å¼•å’Œæ–‡ä»¶å¤¹å°é¢...';
                    globalImageCache = await loadGlobalImageCache(BASE_PATH);
                    message.textContent = 'æ­£åœ¨åŠ è½½ç›¸å†Œå†…å®¹...';
                    if (globalImageCache.length === 0 && folderCoverCache[BASE_PATH] === undefined) {
                        message.textContent = 'åŠ è½½å¤±è´¥ï¼šæ— æ³•è·å–ä»“åº“å†…å®¹ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– GitHub API é™åˆ¶ã€‚';
                        return;
                    }
                }

                const response = await fetch(getContentApiUrl(path));
                if (!response.ok) {
                    throw new Error(`GitHub API é”™è¯¯: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.length === 0) {
                    message.textContent = 'æ­¤ç›¸å†Œä¸ºç©ºã€‚';
                    folderItemsCache = [];
                    renderCurrentPage();
                    return;
                }

                folderItemsCache = data;
                message.style.display = 'none';

                renderCurrentPage(); 
                
            } catch (error) {
                console.error("åŠ è½½ç›¸å†Œå¤±è´¥:", error);
                message.textContent = `åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æˆ– API è®¿é—®é™åˆ¶ã€‚é”™è¯¯ï¼š${error.message}`;
                folderItemsCache = [];
                renderCurrentPage(); 
            }
        }

        /**
         * æœ¬åœ°æ¸²æŸ“å‡½æ•°ï¼šå¤„ç†æœç´¢å’Œåˆ†é¡µ
         */
        function renderCurrentPage() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            isSearching = !!searchTerm;

            const isRoot = currentPath === BASE_PATH;
            const folderName = currentPath.split('/').pop();
            pageTitle.textContent = isSearching ? `æœç´¢ç»“æœï¼š${searchTerm}` : (isRoot ? 'ç›¸å†Œä¸»é¡µ' : `ç›¸å†Œï¼š${folderName}`);

            let filteredItems = [];

            if (isSearching) {
                filteredItems = globalImageCache.filter(item => 
                    item.name.toLowerCase().includes(searchTerm)
                );
            } else {
                const folders = folderItemsCache.filter(item => item.type === 'dir');
                const files = folderItemsCache.filter(item => item.type === 'file' && isImage(item.name));
                filteredItems = [...folders, ...files];
            }
            
            currentItems = filteredItems;

            const totalItems = currentItems.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0 && totalItems > 0) { 
                currentPage = 1;
            } else if (totalPages === 0 && totalItems === 0) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);
            const itemsOnPage = currentItems.slice(startIndex, endIndex);

            gallery.innerHTML = '';
            if (totalItems === 0) {
                 gallery.innerHTML = `<div id="message" style="display:block; width:100%;">æœªæ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®ã€‚</div>`;
                 renderPaginationControls(0);
                 return;
            }
            
            // æ¸²æŸ“è¿”å›ä¸Šä¸€çº§æŒ‰é’® (éæœç´¢æ¨¡å¼ä¸‹)
            if (!isSearching && currentPath !== BASE_PATH) {
                const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                const backButton = createFolderCard('... è¿”å›ä¸Šä¸€çº§', parentPath, true); 
                gallery.appendChild(backButton);
            }

            // æ¸²æŸ“å½“å‰é¡µé¢çš„é¡¹ç›®
            for (const item of itemsOnPage) { // ä½¿ç”¨ for...of æ”¯æŒ await
                if (item.type === 'dir' && !isSearching) {
                    // ğŸ‘ˆ å¼‚æ­¥è·å–æ–‡ä»¶å¤¹å°é¢
                    const coverUrl = folderCoverCache[item.path] || await getFolderCover(item.path);
                    gallery.appendChild(createFolderCard(item.name, item.path, false, coverUrl));
                } else if (item.type === 'file') {
                    gallery.appendChild(createImageCard(item.name, item.path));
                }
            }

            renderPaginationControls(totalPages);
        }

        /**
         * åŠ¨æ€è·å–æ–‡ä»¶å¤¹å°é¢å›¾ (å¦‚æœ cache ä¸­æ²¡æœ‰)
         */
        async function getFolderCover(folderPath) {
            if (folderCoverCache[folderPath]) {
                return folderCoverCache[folderPath];
            }

            try {
                const response = await fetch(getContentApiUrl(folderPath));
                if (!response.ok) return null;
                const data = await response.json();
                
                // æŸ¥æ‰¾å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºå°é¢
                let directImages = data.filter(item => item.type === 'file' && isImage(item.name));
                if (directImages.length > 0) {
                    const cover = getCdnUrl(directImages[0].path); // ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡
                    folderCoverCache[folderPath] = cover;
                    return cover;
                }

                // å¦‚æœå½“å‰æ–‡ä»¶å¤¹æ²¡æœ‰å›¾ç‰‡ï¼Œåˆ™å°è¯•åœ¨å­æ–‡ä»¶å¤¹ä¸­å¯»æ‰¾ (è¿™åœ¨ loadGlobalImageCache ä¸­å·²å¤„ç†)
                // è¿™é‡Œä¸ºäº†æ•ˆç‡ï¼ŒåªæŸ¥æ‰¾å½“å‰å±‚çº§ã€‚æ›´æ·±å±‚çº§åœ¨ loadGlobalImageCache ä¸­ç»Ÿä¸€å¤„ç†ã€‚
                return null;

            } catch (error) {
                console.warn(`è·å–æ–‡ä»¶å¤¹å°é¢å¤±è´¥: ${folderPath}`, error);
                return null;
            }
        }


        /**
         * æ¸²æŸ“åˆ†é¡µæŒ‰é’®
         */
        function renderPaginationControls(totalPages) {
            paginationContainer.innerHTML = '';

            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'ä¸Šä¸€é¡µ';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => { currentPage--; renderCurrentPage(); window.scrollTo(0, 0); }; 
            
            const pageInfo = document.createElement('span');
            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
            pageInfo.style.margin = '0 10px';
            pageInfo.style.fontWeight = 'bold';

            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => { currentPage++; renderCurrentPage(); window.scrollTo(0, 0); }; 

            paginationContainer.appendChild(prevBtn);
            paginationContainer.appendChild(pageInfo);
            paginationContainer.appendChild(nextBtn);
        }

        /* --- å…ƒç´ åˆ›å»ºå‡½æ•° --- */

        function createFolderCard(name, path, isBackButton = false, coverUrl = null) {
            const card = document.createElement('div');
            card.className = `item-card folder-card ${isBackButton ? 'back-button' : ''} ${!coverUrl && !isBackButton ? 'no-cover' : ''}`;
            card.onclick = () => loadAndRenderGallery(path);

            const folderNameDiv = document.createElement('div');
            folderNameDiv.className = 'folder-name';
            folderNameDiv.textContent = name;

            card.appendChild(folderNameDiv);

            if (coverUrl && !isBackButton) {
                card.style.backgroundImage = `url('${coverUrl}')`;
            } else if (!isBackButton) {
                // å¦‚æœæ²¡æœ‰å°é¢å›¾ï¼Œæ˜¾ç¤ºé»˜è®¤å›¾æ ‡å’Œåå­—
                // CSS ä¼šå¤„ç† .no-cover æ ·å¼
            }
            
            return card;
        }

        function createImageCard(name, path) {
            const card = document.createElement('div');
            card.className = 'item-card image-card';

            const imgContainer = document.createElement('div');
            imgContainer.className = 'image-container';

            const img = document.createElement('img');
            img.src = getCdnUrl(path);
            img.alt = name;
            
            const p = document.createElement('p');
            p.textContent = name; 

            imgContainer.appendChild(img);
            card.appendChild(imgContainer);
            card.appendChild(p);

            card.onclick = () => window.open(getCdnUrl(path), '_blank'); 

            return card;
        }

        /* --- äº‹ä»¶ç›‘å¬ --- */

        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1; 
                renderCurrentPage();
            }, 300); 
        });

        // é¡µé¢åˆå§‹åŒ–æ—¶åŠ è½½
        loadAndRenderGallery(BASE_PATH);
    </script>

</body>
</html>