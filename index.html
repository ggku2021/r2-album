<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç›¸å†Œ / My Album</title>
<style>
:root{--gap:10px;--bg:#0f1724;--card:#0b1220;--text:#e6eef8;--folder:#3b82f6}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Noto Sans CJK SC";background:var(--bg);color:var(--text);transition:background 0.3s}
header{padding:16px;text-align:center}
header h1{margin:0;font-size:1.2rem}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:var(--gap);padding:12px;max-width:1200px;margin:0 auto;transition:opacity 0.3s}
.thumb{display:block;overflow:hidden;border-radius:8px;background:var(--card);padding:4px;text-align:center;cursor:pointer;position:relative;transition:transform 0.2s, box-shadow 0.2s}
.thumb img{width:100%;height:160px;object-fit:cover;border-radius:6px;display:block;transition:transform .25s;opacity:0;transition:opacity 0.3s}
.thumb:hover{transform: translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.thumb:hover img{transform:scale(1.03)}
.caption{font-size:0.85rem;padding:6px 4px;text-align:center;color:#cfe6ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* æ–‡ä»¶å¤¹æ ·å¼å¢å¼º */
.thumb.folder::after{
  content: "ğŸ“";
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(0,0,0,0.3);
  border-radius: 4px;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}
.thumb.folder img{filter: brightness(0.8);}

/* é¢åŒ…å±‘å¯¼èˆª */
.breadcrumb{
  font-size:0.8rem;color:#9fb5d9;margin:6px 0 12px;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 0 12px;
}
.breadcrumb .breadcrumb-item{color:#9fb5d9;text-decoration:none;margin:0 4px;}
.breadcrumb .breadcrumb-item:hover{color:#bfdbfe;text-decoration:underline;}
.breadcrumb .breadcrumb-current{color:#e6eef8;font-weight:500;}

/* Lightbox å¤§å›¾é¢„è§ˆ */
.lb{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:999;visibility:hidden;opacity:0;transition:opacity .18s}
.lb.show{visibility:visible;opacity:1}
.lb img{max-width:94vw;max-height:82vh;border-radius:6px;box-shadow:0 8px 30px rgba(0,0,0,.6);transition:opacity 0.3s;opacity:0}
.lb .info{position:fixed;left:16px;bottom:16px;color:#dfeefe;font-size:0.95rem;background:rgba(0,0,0,0.5);padding:4px 8px;border-radius:4px}
.btn{position:fixed;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.4);border:0;color:#fff;font-size:2rem;padding:6px 10px;border-radius:6px;cursor:pointer;transition:background 0.2s}
.btn:hover{background:rgba(0,0,0,.6)}
.prev{left:10px} .next{right:10px}
.close{position:fixed;top:12px;right:12px;background:transparent;border:0;color:#fff;font-size:28px;cursor:pointer;transition:transform 0.2s}
.close:hover{transform:scale(1.1)}

/* åŠ è½½çŠ¶æ€ */
.loading{text-align:center;padding:40px 0;color:#9fb5d9;}
.loading::after{
  content: "";
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
  margin-left: 8px;
  vertical-align: middle;
}
@keyframes spin {to { transform: rotate(360deg); }}

/* å›¾ç‰‡åŠ è½½å¤±è´¥æ ·å¼ */
.thumb img.error{
  background: #1e293b;
  content: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzE0MTQxNCIgZD0iTTEyIDJDMTEuNCAyIDExIDEuNiAxMSAxLjFDMTEgMC41IDEwLjUgMCAxMCAwQzkuNSAwIDkgMC41IDkgMS4xQzkgMS42IDguNiAyIDggMkM0LjcgMiAyIDQuNyAyIDhDMiAxMS4zIDQuNyAxNCA4IDE0QzExLjMgMTQgMTQgMTEuMyAxNCA4QzE0IDQuNyAxMS4zIDIgOCAyTTE4IDhDMThgNiA2IDYgNiA2IDZoLTZDMi43IDggMCAxMC43IDAgMTRDMCAxNy4zIDIuNyAyMCA2IDIwSDIwQzIzLjMgMjAgMjYgMTcuMyAyNiAxNEMyNiAxMC43IDIzLjMgOCAyMCA4WiIvPjxwYXRoIGZpbGw9IiNmOGZmZmYiIGQ9Ik0xMiAxNUMyMS4zIDcgMTYgMTcgMTIgMTdDOC4yIDE3IDMuNyAxNCAzLjcgMTRDMy43IDE0IDAgMTcgNSAxNUMxMC4xIDE1IDEyIDE1IDEyIDE1WiIvPjxwYXRoIGZpbGw9IiNmNWY1ZjUiIGQ9Ik0xMiAxM0g5VjExSDEyVjEzWiIvPjxwYXRoIGZpbGw9IiNmNWY1ZjUiIGQ9Ik0xNCAxMUgxNlY5SDE0VjExWiIvPjwvc3ZnPg==');
  width: 60px;
  height: 60px;
  margin: 50px auto;
  object-fit: contain;
}

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width:480px){ 
  .thumb img{height:120px} 
  .grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));padding:8px}
  .btn{font-size:1.5rem;padding:4px 8px}
  .lb .info{left:8px;bottom:8px;font-size:0.85rem}
}
</style>
</head>
<body>
<header>
  <h1>ç›¸å†Œ / Gallery</h1>
  <div class="breadcrumb" id="breadcrumb">
    <span class="breadcrumb-current">é¦–é¡µ</span>
  </div>
  <div style="font-size:0.85rem;color:#9fb5d9;margin-top:6px">æ”¯æŒå¤šå±‚æ–‡ä»¶å¤¹æµè§ˆ | ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹å¤§å›¾ï¼ˆé”®ç›˜ â† â†’ / Esc æ”¯æŒï¼‰</div>
  <div id="backBtn" style="font-size:0.85rem;color:#93c5fd;margin-top:6px;display:none;cursor:pointer">â† è¿”å›ä¸Šä¸€çº§</div>
</header>

<main>
  <div id="gallery" class="grid" aria-live="polite">
    <div class="loading">åŠ è½½ä¸­</div>
  </div>
</main>

<!-- Lightbox å¤§å›¾é¢„è§ˆ -->
<div id="lightbox" class="lb" role="dialog" aria-hidden="true">
  <button id="closeBtn" class="close" aria-label="å…³é—­">âœ•</button>
  <button id="prevBtn" class="btn prev" aria-label="ä¸Šä¸€å¼ ">â€¹</button>
  <img id="lbImg" src="" alt="" style="opacity:0">
  <button id="nextBtn" class="btn next" aria-label="ä¸‹ä¸€å¼ ">â€º</button>
  <div id="lbCaption" class="info"></div>
</div>

<script>
const jsonPath = 'images.json'; // æŒ‡å‘è‡ªåŠ¨ç”Ÿæˆçš„å›¾ç‰‡ç»“æ„æ–‡ä»¶
let rootImages = []; // æ ¹ç›®å½•å›¾ç‰‡
let folders = []; // ä¸€çº§æ–‡ä»¶å¤¹ï¼ˆå«åµŒå¥—å­æ–‡ä»¶å¤¹ï¼‰
let currentFolderData = null; // å½“å‰æ‰“å¼€çš„æ–‡ä»¶å¤¹æ•°æ®ï¼ˆå«å›¾ç‰‡å’Œå­æ–‡ä»¶å¤¹ï¼‰
let currentImages = []; // å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡åˆ—è¡¨
let currentIndex = 0; // å¤§å›¾é¢„è§ˆå½“å‰ç´¢å¼•
let navigationHistory = []; // å¯¼èˆªå†å²ï¼ˆç”¨äºé¢åŒ…å±‘å’Œå›é€€ï¼‰

// åˆå§‹åŒ–ï¼šåŠ è½½ images.json å¹¶æ¸²æŸ“ç›¸å†Œ
async function initGallery() {
  try {
    const res = await fetch(jsonPath, { cache: 'no-store' }); // ç¦ç”¨ç¼“å­˜ï¼Œç¡®ä¿åŠ è½½æœ€æ–°æ•°æ®
    if (!res.ok) throw new Error(`è¯»å–å¤±è´¥ï¼š${res.status} ${res.statusText}`);
    
    const data = await res.json();
    rootImages = data.root || [];
    folders = data.folders || [];
    
    renderGallery(); // æ¸²æŸ“ç›¸å†Œé¡µé¢
  } catch (e) {
    console.error('ç›¸å†ŒåŠ è½½å¤±è´¥ï¼š', e);
    document.getElementById('gallery').innerHTML = `
      <div style="padding:20px;color:#f88;text-align:center">
        è½½å…¥å›¾ç‰‡å¤±è´¥ï¼<br>
        è¯·æ£€æŸ¥ images.json æ˜¯å¦å­˜åœ¨æˆ–æ ¼å¼æ­£ç¡®<br>
        é”™è¯¯ä¿¡æ¯ï¼š${e.message}
      </div>
    `;
  }
}

// æ¸²æŸ“ç›¸å†Œé¡µé¢ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
function renderGallery() {
  const galleryContainer = document.getElementById('gallery');
  galleryContainer.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
  galleryContainer.style.opacity = '0'; // æ·¡å…¥æ•ˆæœå‡†å¤‡

  // åŒºåˆ†â€œé¦–é¡µâ€å’Œâ€œæ–‡ä»¶å¤¹å†…é¡µé¢â€
  if (!currentFolderData) {
    // é¦–é¡µï¼šæ¸²æŸ“æ ¹ç›®å½•å›¾ç‰‡ + ä¸€çº§æ–‡ä»¶å¤¹
    let galleryHtml = '';
    
    // 1. æ¸²æŸ“æ ¹ç›®å½•å›¾ç‰‡
    if (rootImages.length > 0) {
      rootImages.forEach((img, index) => {
        galleryHtml += `
          <a href="#" class="thumb" data-type="root-img" data-index="${index}">
            <img src="${img.url}" alt="${img.title}" 
                 onload="this.style.opacity='1'" 
                 onerror="this.classList.add('error');this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥'">
            <div class="caption">${img.title}</div>
          </a>
        `;
      });
    }

    // 2. æ¸²æŸ“ä¸€çº§æ–‡ä»¶å¤¹
    if (folders.length > 0) {
      folders.forEach(folder => {
        galleryHtml += `
          <a href="#" class="thumb folder" data-type="folder" data-folder='${JSON.stringify(folder)}'>
            <img src="${folder.cover || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzNiODJmNiIgZD0iTTEyIDJDMTEuNCAyIDExIDEuNiAxMSAxLjFDMTEgMC41IDEwLjUgMCAxMCAwQzkuNSAwIDkgMC41IDkgMS4xQzkgMS42IDguNiAyIDggMkM0LjcgMiAyIDQuNyAyIDhDMiAxMS4zIDQuNyAxNCA4IDE0QzExLjMgMTQgMTQgMTEuMyAxNCA4QzE0IDQuNyAxMS4zIDIgOCAyTTE4IDhDMTh2MTBDMTggMTguOCAxNy4yIDIwIDE2IDIwSDhDMi4yIDIwIDIgMTguOCAyIDE4VjhDMiA3LjIgMi44IDYgNCA2SDIwQzIxLjIgNiAyMiA2LjIgMjIgOFoiLz48L3N2Zz4='}" 
                 alt="${folder.folder}" 
                 onload="this.style.opacity='1'" 
                 onerror="this.classList.add('error');this.alt='å°é¢åŠ è½½å¤±è´¥'">
            <div class="caption">${folder.folder}</div>
          </a>
        `;
      });
    }

    // æ— å›¾ç‰‡å’Œæ–‡ä»¶å¤¹æ—¶æ˜¾ç¤ºæç¤º
    if (galleryHtml === '') {
      galleryHtml = '<div style="padding:40px;color:#9fb5d9;text-align:center">æš‚æ— å›¾ç‰‡ï¼Œè¯·å…ˆä¸Šä¼ å›¾ç‰‡åˆ° img ç›®å½•</div>';
    }

    galleryContainer.innerHTML = galleryHtml;
    document.getElementById('backBtn').style.display = 'none'; // é¦–é¡µéšè—â€œè¿”å›â€æŒ‰é’®
  } else {
    // æ–‡ä»¶å¤¹å†…é¡µé¢ï¼šæ¸²æŸ“å½“å‰æ–‡ä»¶å¤¹å›¾ç‰‡ + åµŒå¥—å­æ–‡ä»¶å¤¹
    let galleryHtml = '';
    
    // 1. æ¸²æŸ“åµŒå¥—å­æ–‡ä»¶å¤¹ï¼ˆå¦‚æœ‰ï¼‰
    if (currentFolderData.subfolders && currentFolderData.subfolders.length > 0) {
      currentFolderData.subfolders.forEach(subfolder => {
        galleryHtml += `
          <a href="#" class="thumb folder" data-type="folder" data-folder='${JSON.stringify(subfolder)}'>
            <img src="${subfolder.cover || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzNiODJmNiIgZD0iTTEyIDJDMTEuNCAyIDExIDEuNiAxMSAxLjFDMTEgMC41IDEwLjUgMCAxMCAwQzkuNSAwIDkgMC41IDkgMS4xQzkgMS42IDguNiAyIDggMkM0LjcgMiAyIDQuNyAyIDhDMiAxMS4zIDQuNyAxNCA4IDE0QzExLjMgMTQgMTQgMTEuMyAx
